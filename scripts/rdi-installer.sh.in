#!/bin/bash

# SPDX-License-Identifier: MIT

COLOR_GREEN=10
COLOR_GRAY=250
COLOR_RED=9
COLOR_BLUE=21
COLOR_DARKBLUE=18
COLOR_CYAN=14

COLOR_BACKGROUND=$COLOR_DARKBLUE
COLOR_FOREGROUND=$COLOR_GREEN
COLOR_ITEM=$COLOR_GRAY
COLOR_TITLE=$COLOR_BLUE
COLOR_TEXT=$COLOR_CYAN
COLOR_WARNING=$COLOR_RED

CURSOR="â†’"

VERSION=@VERSION@

if [ -z "$RDII_DEBUG" ]; then
    KEYWAIT=keywait

    # shellcheck source=../scripts/keymap.sh
    source @RDIIDIR@/keymap.sh
    # shellcheck source=../scripts/target_device.sh
    source @RDIIDIR@/target_device.sh
    # shellcheck source=../scripts/select_image.sh
    source @RDIIDIR@/select_image.sh
else
    KEYWAIT=./keywait

    source ../scripts/keymap.sh
    source ../scripts/target_device.sh
    source ../scripts/select_image.sh
fi

clear_and_print_title()
{
    clear
    gum style \
	--align center \
	--width 80 \
	--background "$COLOR_BACKGROUND" \
	--foreground "$COLOR_FOREGROUND" \
	"Raw Disk Image Installer ${VERSION}"
    echo ""
}

# Check for gum
if ! command -v gum &> /dev/null; then
    echo "Error: 'gum' is not installed."
    exit 1
fi

#
# Initialize some defaults
#
# Read current KEYMAP from /etc/vconsole.conf
DEFAULT_KEYMAP="us"
VCONSOLE_FILE="/etc/vconsole.conf"
TARGET_DEVICE=""
SOURCE_IMAGE=""

if [ -f "$VCONSOLE_FILE" ]; then
    # sourcing in a subshell to avoid polluting current environment,
    # though straightforward sourcing is also fine.
    # shellcheck source=/dev/null
    DEFAULT_KEYMAP=$(source "$VCONSOLE_FILE" && echo "$KEYMAP")
fi

clear

# Splash screen at start

gum style \
    --border double \
    --align center \
    --width 70 \
    --margin "1 2" \
    --padding "2 4" \
    --border-background "$COLOR_BACKGROUND"\
    --border-foreground "$COLOR_FOREGROUND" \
    --background "$COLOR_BACKGROUND" \
    --foreground "$COLOR_FOREGROUND" \
    "Raw Disk Image Installer ${VERSION}"

gum spin --spinner=globe --title.foreground="$COLOR_TITLE" --title="Press any key to continue or wait 5s..." -- $KEYWAIT -t ""

# Main menu
SELECTED="start"

# We quit if user hits ESC, Ctrl-C or selects Install/Abort
while [ "$SELECTED" != "Install" ] && [ "$SELECTED" != "Abort" ] && [ -n "$SELECTED" ]; do
    clear_and_print_title

    SELECTED=$(gum choose \
		   --header="Configuration Settings" \
		   --cursor="${CURSOR} " \
		   --cursor.foreground="$COLOR_FOREGROUND" \
		   --item.foreground="$COLOR_ITEM" \
		   --selected.foreground="$COLOR_FOREGROUND" \
		   --header.foreground="$COLOR_TITLE" \
		   --limit=1 \
		   "Select Keymap ($DEFAULT_KEYMAP)" \
		   "Select Target Device ($TARGET_DEVICE)" \
		   "Select Image ($(basename "$SOURCE_IMAGE"))" \
		   "Abort" \
		   "Install"
	    )

    case "$SELECTED" in
	"Select Keymap"*)
	    set_keymap
	    ;;
	"Select Target Device"*)
	    select_target_device
	    ;;
	"Select Image"*)
	    select_image
	    ;;
	"Abort" | "")
	    gum style --foreground="$COLOR_TITLE" "Exiting..."
	    exit 3
	    ;;
	"Install")
	    if [ -z "$SOURCE_IMAGE" ]; then
		gum style \
		    --foreground="$COLOR_WARNING" \
		    "You need to select a raw disk image first!"
		$KEYWAIT -t ""
		SELECTED="start"
	    fi
	    if [ -z "$TARGET_DEVICE" ]; then
		gum style \
		    --foreground="$COLOR_WARNING" \
		    "You need to select a target device first!"
		$KEYWAIT -t ""
		SELECTED="start"
	    fi
	    ;;
	*)
	    echo "Internal Error: '$SELECTED'"
	    exit 2
	    ;;
    esac
done

clear
gum style \
    --align="center" \
    --border-foreground "$COLOR_FOREGROUND" \
    --foreground "$COLOR_FOREGROUND" \
    --bold \
    "Source Image:" \
    "$SOURCE_IMAGE" \
    "Installation Target:" \
    "$TARGET_DEVICE"


clear_and_print_title

if gum confirm \
       --default \
       --prompt.foreground "$COLOR_TEXT" \
       --selected.background "$COLOR_WARNING" \
       --selected.foreground "$COLOR_FOREGROUND" \
       --unselected.background "$COLOR_BACKGROUND" \
       "WARNING: PERMANENT DATA LOSS - Are you absolutely sure?"; then
        gum style --foreground "$COLOR_TEXT" "Confirmed. Proceeding with writing $SOURCE_IMAGE to $TARGET_DEVICE..."
    else
        gum style --foreground "$COLOR_TEXT" "Aborted."
        $KEYWAIT -t "" -s 2
	exit 1
    fi

if [ -z "$RDII_DEBUG" ]; then
    # Write the image
    if ! dd if="$SOURCE_IMAGE" of="$TARGET_DEVICE" bs=4M status=progress conv=fsync oflag=direct ; then
	$KEYWAIT -s 0
    else
	$KEYWAIT -s 10
    fi
else
    gum spin --spinner=globe --title.foreground="$COLOR_TITLE" --title="Press any key to continue or wait 5s..." -- $KEYWAIT -t "" -s 10
fi
clear_and_print_title
ACTION=$(gum choose \
	     --cursor="${CURSOR} " \
	     --cursor.foreground="$COLOR_FOREGROUND" \
	     --item.foreground="$COLOR_ITEM" \
	     --selected.foreground="$COLOR_FOREGROUND" \
	     --limit=1 \
	     "Reboot" "PowerOff" "Quit (shell)")
case $ACTION in
    Reboot)
	reboot
	;;
    PowerOff)
	poweroff
	;;
    *)
	;;
esac
